{
  "custom_summary": "Job Clusters EOS Alert",
  "evaluation": {
    "source": {
      "name": "is_supported",
      "display": "is_supported",
      "aggregation": "COUNT"
    },
    "comparison_operator": "GREATER_THAN",
    "threshold": {
      "value": {
        "double_value": 0.0
      }
    },
    "empty_result_state": "OK",
    "notification": {
      "retrigger_seconds": 1,
      "notify_on_ok": false
    }
  },
  "schedule": {
    "quartz_cron_schedule": "29 20 6 * * ?",
    "timezone_id": "America/New_York"
  },
  "query_lines": [
    "WITH",
    "filtered_usage AS (",
    "  SELECT",
    "    u.workspace_id,",
    "    u.usage_metadata.cluster_id,",
    "    u.usage_metadata.job_id,",
    "    u.usage_quantity,",
    "    u.identity_metadata.run_as,",
    "    u.sku_name,",
    "    u.usage_date",
    "  FROM",
    "    system.billing.usage u",
    "  WHERE",
    "    u.billing_origin_product = 'JOBS'",
    "    AND u.usage_metadata.node_type != 'SERVERLESS'",
    "    AND u.usage_metadata.job_id IS NOT NULL",
    "    AND u.usage_date >= CURRENT_DATE - INTERVAL 30 DAYS",
    "    --AND (:workspace_ids = ARRAY('All') OR array_contains(:workspace_ids, u.workspace_id))",
    "    GROUP BY ALL",
    "),",
    "",
    "-- Price lookup",
    "price_lookup AS (",
    "  SELECT ",
    "    sku_name,",
    "    pricing.effective_list.default AS price_per_dbu",
    "  FROM system.billing.list_prices",
    "  WHERE price_end_time IS NULL",
    "),",
    "",
    "-- Join with cluster and parse DBR version",
    "usage_with_dbr AS (",
    "  SELECT",
    "    fu.workspace_id,",
    "    fu.cluster_id,",
    "    fu.job_id,",
    "    fu.usage_date,",
    "    fu.usage_quantity,",
    "    fu.run_as,",
    "    pl.price_per_dbu,",
    "    NULLIF(regexp_extract(c.dbr_version, '\\\\d+\\\\.\\\\d', 0), '') AS dbr_version",
    "  FROM",
    "    filtered_usage fu",
    "  JOIN system.compute.clusters c",
    "    ON fu.cluster_id = c.cluster_id",
    "  JOIN price_lookup pl",
    "    ON fu.sku_name = pl.sku_name",
    "  WHERE dbr_version IS NOT NULL",
    ")",
    "",
    "-- Aggregate per job",
    "",
    " SELECT",
    "   u.workspace_id,",
    "   u.job_id,",
    "   u.dbr_version,",
    "   coalesce(wn.dbr_version, u.dbr_version) as dbr_version_lts_ind,",
    "   CASE WHEN wn.end_of_support_date IS NOT NULL THEN datediff(wn.end_of_support_date, current_date) ELSE 0 END AS days_till_eos, --days till end of support",
    "   max(u.usage_date) as latest_usage_date,",
    "   ARRAY_AGG(DISTINCT u.run_as) AS run_identities,",
    "   MAX(CASE",
    "     WHEN wn.end_of_support_date IS NOT NULL AND CURRENT_DATE <= wn.end_of_support_date THEN TRUE",
    "     ELSE FALSE",
    "   END) AS is_supported",
    " FROM",
    "   usage_with_dbr u",
    " LEFT JOIN dbdemos.lookup.dbr_version wn ",
    "   ON u.dbr_version = wn.clean_dbr_version",
    " GROUP BY",
    "   u.workspace_id, u.job_id, u.dbr_version, dbr_version_lts_ind, days_till_eos",
    "HAVING is_supported = false"
  ],
  "custom_description_lines": [
    "Alert \"{{ALERT_NAME}}\" changed status to {{ALERT_STATUS}}.<br>",
    "We recommend upgrading all clusters running DBR that are nearing or past the end of service to serverless. <br>",
    "Serverless clusters automatically manage DBR for you, ensuring they are supported.<br>",
    "Query result value: {{QUERY_RESULT_VALUE}}<br>",
    "<a href=\"{{ALERT_URL}}\">Go to alert</a> | ",
    "<a href=\"https://e2-demo-field-eng.cloud.databricks.com/dashboardsv3/01f02ac3cb7c120cbe01a4e762bb4284/published/pages/b07e7319?o=1444828305810485\">Go to dashboard</a>"
  ]
}
