{
  "custom_summary": "Interactive Clusters EOS Alert",
  "evaluation": {
    "source": {
      "name": "is_supported",
      "display": "is_supported",
      "aggregation": "COUNT"
    },
    "comparison_operator": "GREATER_THAN",
    "threshold": {
      "value": {
        "double_value": 0.0
      }
    },
    "empty_result_state": "OK",
    "notification": {
      "retrigger_seconds": 1,
      "notify_on_ok": false
    }
  },
  "schedule": {
    "quartz_cron_schedule": "29 20 6 * * ?",
    "timezone_id": "America/New_York"
  },
  "query_lines": [
    "-- Get clusters and latest change time",
    "WITH ",
    "latest_cluster_versions AS (",
    "  SELECT",
    "    cluster_id,",
    "    MAX(change_time) AS latest_change_time",
    "  FROM",
    "    system.compute.clusters",
    "  GROUP BY",
    "    cluster_id",
    "),",
    "",
    "filtered_usage AS (",
    "  SELECT",
    "    u.workspace_id,",
    "    u.usage_metadata.cluster_id,",
    "    u.usage_quantity,",
    "    u.sku_name,",
    "    u.usage_date",
    "  FROM",
    "    system.billing.usage u",
    "  WHERE",
    "    u.billing_origin_product = 'ALL_PURPOSE'",
    "    AND u.usage_metadata.node_type != 'SERVERLESS'",
    "    AND u.usage_date >= CURRENT_DATE - INTERVAL 30 DAYS",
    "    --AND (:workspace_ids = Array('All') OR array_contains(:workspace_ids, u.workspace_id))",
    "),",
    "",
    "latest_cluster_info AS (",
    "  SELECT",
    "    c.cluster_id,",
    "    c.cluster_name,",
    "    c.owned_by,",
    "    c.dbr_version,",
    "    c.change_time",
    "  FROM",
    "    system.compute.clusters c",
    "  JOIN latest_cluster_versions lcv",
    "    ON c.cluster_id = lcv.cluster_id",
    "    AND c.change_time = lcv.latest_change_time",
    "),",
    "",
    "",
    "combined AS (",
    "  SELECT",
    "    u.workspace_id,",
    "    u.cluster_id,",
    "    c.cluster_name,",
    "    c.owned_by,",
    "    u.usage_date,",
    "    NULLIF(regexp_extract(dbr_version, '\\\\d+\\\\.\\\\d', 0), '') AS dbr_version",
    "  FROM",
    "    filtered_usage u",
    "  JOIN latest_cluster_info c ON u.cluster_id = c.cluster_id",
    "  WHERE dbr_version IS NOT NULL",
    ")",
    "",
    "SELECT",
    "workspace_id,",
    "cluster_id,",
    "cluster_name,",
    "owned_by,",
    "coalesce(wn.dbr_version, combined.dbr_version) as dbr_version_lts_ind,",
    "max(usage_date) as latest_usage_date,",
    "MAX(CASE",
    "    WHEN wn.end_of_support_date IS NOT NULL AND CURRENT_DATE <= wn.end_of_support_date THEN TRUE",
    "    ELSE FALSE",
    "END) AS is_supported",
    "FROM combined",
    "LEFT JOIN dbdemos.lookup.dbr_version wn",
    "ON combined.dbr_version = wn.clean_dbr_version",
    "GROUP BY workspace_id, cluster_id, cluster_name, owned_by, dbr_version_lts_ind",
    "HAVING is_supported = false"
  ],
  "custom_description_lines": [
    "Alert \"{{ALERT_NAME}}\" changed status to {{ALERT_STATUS}}.<br>",
    "We recommend upgrading all clusters running DBR that are nearing or past the end of service to serverless. <br>",
    "Serverless clusters automatically manage DBR for you, ensuring they are supported.<br>",
    "Query result value: {{QUERY_RESULT_VALUE}}<br>",
    "<a href=\"{{ALERT_URL}}\">Go to alert</a> | ",
    "<a href=\"https://e2-demo-field-eng.cloud.databricks.com/dashboardsv3/01f02ac3cb7c120cbe01a4e762bb4284/published/pages/b07e7319?o=1444828305810485\">Go to dashboard</a>"
  ]
}
