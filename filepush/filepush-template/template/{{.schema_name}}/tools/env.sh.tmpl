#!/usr/bin/env bash
# This file is used to set the environment variables for the filepush bundle.
# It is sourced by the other scripts in the tools directory.
# This should be deployed **after** the bundle is deployed.

# Prevent running directly; this file must be *sourced*
(return 0 2>/dev/null) || { echo "Source this file:  . $(basename "$0")"; exit 1; }

# Idempotent guard
# Check if the environment is already set and non-empty
if [[ -n "${_FILEPUSH_ENV_LOADED:-}" ]]; then
  return 0
fi
export _FILEPUSH_ENV_LOADED=1

summary=$(databricks bundle summary --output json)
export FILEPUSH_CATALOG_NAME={{.catalog_name}}
export FILEPUSH_SCHEMA_NAME=$(echo $summary | jq -r '.resources.schemas.{{.schema_name}}.name')
export FILEPUSH_VOLUME_PATH=/Volumes/{{.catalog_name}}/${FILEPUSH_SCHEMA_NAME}/{{.schema_name}}_volume/
export FILEPUSH_PIPELINE_ID=$(echo $summary | jq -r '.resources.pipelines.{{.schema_name}}_pipeline.id')
export FILEPUSH_JOB_NAME={{.schema_name}}_job
